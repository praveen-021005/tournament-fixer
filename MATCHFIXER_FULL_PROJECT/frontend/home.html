<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tournament Fixer</title>
<link rel="stylesheet" href="home.css">
</head>
<body>
  <div class="sidebar">
    <h1>Tournament Fixer</h1>
    <div class="info">Create a bracket: choose sport, number of teams, enter names, then generate. Click team names in each match to advance them.</div>

    <label>Choose game</label>
    <select id="gameSelect">
      <option>Cricket</option>
      <option>Badminton</option>
      <option>Volleyball</option>
      <option>Basketball</option>
      <option>Football</option>
      <option>Table Tennis</option>
      <option>Custom</option>
    </select>

    <label>Number of teams (2â€“64)</label>
    <input id="numTeams" type="number" min="2" max="64" value="8" />

    <div class="controls">
      <button id="setTeamsBtn">Set teams</button>
      <button class="ghost" id="randomFillBtn">Random fill</button>
    </div>

    <div id="teamsContainer" class="teams-list"></div>

    <div class="controls" style="margin-top:12px">
      <button id="generateBtn">Generate Bracket</button>
      <button class="ghost" id="resetBtn">Reset</button>
    </div>

    <div style="margin-top:12px">
      <div class="info"><strong>Tip:</strong> If number of teams isn't a power of two, byes are added automatically.</div>
    </div>
  </div>

  <div class="board">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px">
      <div>
        <strong id="boardTitle">No bracket generated</strong>
        <div style="font-size:12px;color:var(--muted)" id="boardSub">Select options on the left and click Generate Bracket</div>
      </div>
      <div>
        <button id="exportBtn" class="ghost">Export JSON</button>
      </div>
    </div>

    <div id="roundsWrap" class="rounds" aria-live="polite"></div>
  </div>

<script>
/* Tournament bracket generator (safe) */
const teamsContainer = document.getElementById('teamsContainer');
const setTeamsBtn = document.getElementById('setTeamsBtn');
const numTeamsInput = document.getElementById('numTeams');
const randomFillBtn = document.getElementById('randomFillBtn');
const generateBtn = document.getElementById('generateBtn');
const resetBtn = document.getElementById('resetBtn');
const roundsWrap = document.getElementById('roundsWrap');
const boardTitle = document.getElementById('boardTitle');
const boardSub = document.getElementById('boardSub');
const exportBtn = document.getElementById('exportBtn');
const gameSelect = document.getElementById('gameSelect');

let currentTeams = [];

function createTeamInputs(n){
  teamsContainer.innerHTML = '';
  for(let i=0;i<n;i++){
    const row = document.createElement('div');
    row.className = 'team-row';
    const input = document.createElement('input');
    input.className = 'team-input';
    input.placeholder = `Team ${i+1} name`;
    input.value = '';
    row.appendChild(input);
    teamsContainer.appendChild(row);
  }
}

setTeamsBtn.addEventListener('click', ()=>{
  let n = parseInt(numTeamsInput.value) || 2;
  n = Math.max(2, Math.min(64, n));
  createTeamInputs(n);
});

randomFillBtn.addEventListener('click', ()=>{
  const suggestions = ["Tigers","Lions","Eagles","Warriors","Knights","Falcons","Dragons","Spartans","Raptors","Vipers","Panthers","Bulls","Sharks","Rangers","Comets","Storm"];
  const inputs = teamsContainer.querySelectorAll('.team-input');
  inputs.forEach((inp,idx)=>{
    inp.value = suggestions[(idx)%suggestions.length] + (Math.floor(Math.random()*99)+1);
  });
});

resetBtn.addEventListener('click', ()=>{
  teamsContainer.innerHTML='';
  roundsWrap.innerHTML='';
  boardTitle.textContent = 'No bracket generated';
  boardSub.textContent = 'Select options on the left and click Generate Bracket';
  currentTeams=[];
});

function nextPow2(x){ return Math.pow(2, Math.ceil(Math.log2(x))); }

function buildBracket(teams){
  // pad with BYE to next power of two
  const target = nextPow2(teams.length);
  const padded = teams.slice();
  while(padded.length < target) padded.push('BYE');

  // rounds: array of arrays of matches, match is [teamA, teamB, winner]
  const rounds = [];
  let currentRound = [];
  for(let i=0;i<padded.length;i+=2){
    currentRound.push({a: padded[i], b: padded[i+1], winner: null});
  }
  rounds.push(currentRound);
  let size = currentRound.length;
  while(size > 1){
    size = Math.ceil(size/2);
    const next = Array.from({length:size}, ()=>({a:null,b:null,winner:null}));
    rounds.push(next);
  }
  return rounds;
}

function renderBracket(rounds){
  roundsWrap.innerHTML = '';
  const totalRounds = rounds.length;
  for(let r=0;r<totalRounds;r++){
    const col = document.createElement('div');
    col.className='round';
    const roundName = r===0 ? 'Round 1' : (r===totalRounds-1 ? 'Final' : `Round ${r+1}`);
    const h3 = document.createElement('h3');
    h3.textContent = roundName;
    col.appendChild(h3);

    rounds[r].forEach((m,mi)=>{
      const match = document.createElement('div');
      match.className='match';
      match.dataset.round = r;
      match.dataset.match = mi;

      const teamA = document.createElement('div');
      teamA.className='team';
      const aLabel = document.createElement('div');
      aLabel.textContent = m.a || '';
      const aBtn = document.createElement('button');
      aBtn.className='winner-btn';
      aBtn.textContent = 'Select';
      aBtn.addEventListener('click', ()=>selectWinner(r,mi,'a'));
      teamA.appendChild(aLabel);
      teamA.appendChild(aBtn);

      const teamB = document.createElement('div');
      teamB.className='team';
      const bLabel = document.createElement('div');
      bLabel.textContent = m.b || '';
      const bBtn = document.createElement('button');
      bBtn.className='winner-btn';
      bBtn.textContent = 'Select';
      bBtn.addEventListener('click', ()=>selectWinner(r,mi,'b'));
      teamB.appendChild(bLabel);
      teamB.appendChild(bBtn);

      if((m.a === 'BYE' && m.b && m.b !== 'BYE') || (m.b === 'BYE' && m.a && m.a !== 'BYE')){
        // auto-advance non-BYE
        const winnerKey = (m.a==='BYE') ? 'b' : 'a';
        // small timeout to allow DOM render
        setTimeout(()=>selectWinner(r,mi,winnerKey, true), 20);
      }

      match.appendChild(teamA);
      match.appendChild(teamB);

      // connector only if not last round
      if(r < totalRounds -1){
        const conn = document.createElement('div');
        conn.className='connector';
        match.appendChild(conn);
      }
      col.appendChild(match);
    });
    roundsWrap.appendChild(col);
  }
}

let bracketRounds = [];

function generateFromInputs(){
  const inputs = Array.from(document.querySelectorAll('.team-input')).map(i=>i.value.trim()).filter((x,i,arr)=>true);
  const filtered = inputs.map((v,idx)=> v? v : `Team ${idx+1}`);
  if(filtered.length < 2){
    alert('Please provide at least 2 teams.');
    return;
  }
  currentTeams = filtered;
  bracketRounds = buildBracket(currentTeams);
  // copy team names into round 0 matches
  bracketRounds[0].forEach((m,i)=>{
    // m.a and m.b already set by buildBracket
  });
  boardTitle.textContent = `${gameSelect.value} - ${currentTeams.length} teams`;
  boardSub.textContent = `Click a team name's "Select" button to mark winner of that match.`;
  renderBracket(bracketRounds);
}

// select winner logic
function selectWinner(roundIdx, matchIdx, slot, auto=false){
  const match = bracketRounds[roundIdx][matchIdx];
  const winnerName = slot === 'a' ? match.a : match.b;
  if(!winnerName) return;
  // mark winner in current match
  match.winner = winnerName;

  // update DOM visuals
  const matchDiv = document.querySelector(`.match[data-round="${roundIdx}"][data-match="${matchIdx}"]`);
  if(matchDiv){
    const teams = matchDiv.querySelectorAll('.team');
    teams.forEach(t=>{
      t.classList.remove('selected');
    });
    const chosen = matchDiv.querySelector(slot==='a'?'.team:first-child':'.team:last-child');
    if(chosen) chosen.classList.add('selected');
    const btns = matchDiv.querySelectorAll('.winner-btn');
    btns.forEach(b=> b.textContent = 'Select');
    const chosenBtn = slot==='a' ? matchDiv.querySelector('.team:first-child .winner-btn') : matchDiv.querySelector('.team:last-child .winner-btn');
    if(chosenBtn) chosenBtn.textContent = 'Winner';
  }

  // place winner into next round slot
  if(roundIdx + 1 < bracketRounds.length){
    const nextMatchIdx = Math.floor(matchIdx/2);
    const isFirstSlot = (matchIdx %2 === 0);
    if(isFirstSlot){
      bracketRounds[roundIdx+1][nextMatchIdx].a = winnerName;
    } else {
      bracketRounds[roundIdx+1][nextMatchIdx].b = winnerName;
    }
    // If the opponent is BYE, auto-advance
    const nm = bracketRounds[roundIdx+1][nextMatchIdx];
    if((nm.a && nm.a==='BYE' && nm.b && nm.b!=='BYE') || (nm.b && nm.b==='BYE' && nm.a && nm.a!=='BYE')){
      const winnerKey = nm.a==='BYE' ? 'b' : 'a';
      // immediate select next round winner
      setTimeout(()=>selectWinner(roundIdx+1,nextMatchIdx,winnerKey,true), 40);
    }
  } else {
    // last round winner: tournament winner selected
    boardSub.textContent = `Champion: ${winnerName} ðŸ†`;
  }
  // re-render rounds to show updates
  renderBracket(bracketRounds);
}

// Export JSON of bracket
exportBtn.addEventListener('click', ()=>{
  if(!bracketRounds || bracketRounds.length===0){ alert('No bracket to export.'); return; }
  const payload = {
    game: gameSelect.value,
    teams: currentTeams,
    rounds: bracketRounds
  };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download = `${gameSelect.value}_bracket.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

generateBtn.addEventListener('click', generateFromInputs);

// --- NEW: send to backend when generating ---
async function sendToBackend() {
  try {
    const game = gameSelect.value;
    const numTeams = parseInt(numTeamsInput.value) || 0;
    const teams = Array.from(document.querySelectorAll('.team-input')).map(i => i.value.trim() || 'Unnamed');

    const payload = { game, numTeams, teams, timestamp: new Date().toISOString() };

    const response = await fetch("http://localhost:8080/submit-tournament", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if(!response.ok) {
      const t = await response.text();
      alert('Backend error: ' + t);
      return;
    }
    const result = await response.json();
    alert(result.message || 'Submitted to backend');
  } catch (err) {
    alert('Could not reach backend. Make sure the Java backend is running on http://localhost:8080');
    console.error(err);
  }
}

generateBtn.addEventListener('click', async () => {
  generateFromInputs();
  // small delay to ensure inputs exist
  setTimeout(()=>sendToBackend(), 120);
});

// initialize with default team inputs
createTeamInputs(parseInt(numTeamsInput.value) || 8);
</script>
</body>
</html>
